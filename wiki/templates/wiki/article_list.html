{% extends "base.html" %}

{% block title %}Flight Ops Wiki{% endblock %}

{% block head %}
  {{ block.super }}
  <style>
    .intel-hero {
      background: var(--surface);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: clamp(1.75rem, 4vw, 3rem);
      margin-bottom: 2rem;
      box-shadow: var(--shadow-card);
      transition: background 0.35s var(--ease), border-color 0.35s var(--ease), box-shadow 0.35s var(--ease);
    }
    .intel-hero h2 {
      margin: 0 0 0.5rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
    }
    .intel-hero p {
      color: var(--text-secondary);
      max-width: 580px;
      line-height: 1.6;
    }
    .intel-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .intel-stats li {
      list-style: none;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      background: var(--accent-dim);
      font-size: 0.95rem;
      color: var(--text);
      transition: border-color 0.2s ease, background 0.35s var(--ease);
    }
    .intel-stats .label {
      display: block;
      font-size: 0.75rem;
      letter-spacing: 0.25em;
      color: var(--accent);
      margin-bottom: 0.35rem;
      text-transform: uppercase;
    }
    .topic-band {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
    .topic-chip {
      border: 1px solid var(--border-active);
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      white-space: nowrap;
      background: var(--accent-dim);
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }
    .topic-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .intel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .intel-card {
      background: var(--surface);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      padding: 1.6rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      transition: box-shadow 0.25s ease, border-color 0.25s ease, background 0.35s var(--ease);
    }
    .intel-card:hover {
      box-shadow: var(--shadow-elevated);
      border-color: var(--border-active);
    }
    .intel-card h3 {
      margin: 0;
    }
    .intel-card h3 a {
      color: var(--text);
      text-decoration: none;
      transition: color 0.15s ease;
    }
    .intel-card h3 a:hover {
      color: var(--accent);
    }
    .intel-card .summary {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
      flex: 1;
    }
    .tag-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }
    .tag-chip {
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      border: 1px solid var(--border-active);
      border-radius: 999px;
      padding: 0.2rem 0.8rem;
      color: var(--text-muted);
      transition: color 0.2s ease;
    }
    .pager {
      margin-top: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* user admin panel */
    .users-panel {
      background: var(--surface);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: clamp(1.25rem, 3vw, 2rem);
      margin-top: 2rem;
      box-shadow: var(--shadow-card);
      transition: background 0.35s var(--ease), border-color 0.35s var(--ease);
    }
    .users-panel h2 {
      margin: 0 0 1rem;
      font-size: 1.1rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text);
    }
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th {
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      padding: 0.6rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .users-table td {
      padding: 0.65rem 0.75rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }
    .users-table tr:last-child td { border-bottom: none; }
    .users-table tr:hover td { background: var(--accent-dim); }

    .status-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--accent-dim);
      color: var(--text-muted);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .status-toggle.approved {
      border-color: var(--accent);
      color: var(--accent);
    }
    .status-toggle:hover {
      box-shadow: 0 0 0 3px var(--accent-dim);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background 0.2s ease;
    }
    .status-toggle.approved .status-dot {
      background: var(--accent);
    }
  </style>
{% endblock %}

{% block content %}
<section class="intel-hero">
    <h2>Flight Ops Knowledge</h2>
    <p>Живе досьє по техніці, процедурних картах, доктринах та перевірених польових нотатках. Шукайте по ключових словах або оберіть тематику, щоб миттєво потрапити до потрібного брифу.</p>
    <ul class="intel-stats">
        <li>
            <span class="label">Документів</span>
            {{ page_obj.paginator.count }}
        </li>
        <li>
            <span class="label">Сторінка</span>
            {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}
        </li>
        <li>
            <span class="label">Запит</span>
            {{ query|default:"—" }}
        </li>
    </ul>
    <form class="search" role="search" method="get">
        <input type="search" name="q" value="{{ query }}" placeholder="Шукати статті, теги, доктрини…" />
        <button type="submit">Сканувати</button>
    </form>
    {% if topics %}
    <div class="topic-band">
        {% for topic in topics %}
            {% if topic.slug %}
                <a class="topic-chip" href="{% url 'wiki:topic_articles' topic.slug %}">
                    {{ topic.icon }} {{ topic.name }}
                </a>
            {% else %}
                <span class="topic-chip">{{ topic.name }}</span>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</section>

{% if page_obj.object_list %}
<div class="intel-grid">
    {% for article in page_obj.object_list %}
    <article class="intel-card">
        <div>
            <p class="muted" style="margin:0;">
                {% if article.topic %}{{ article.topic.icon }} {{ article.topic.name }}{% else %}Окрема нотатка{% endif %}
            </p>
            <h3>
                <a href="{% url 'wiki:article_detail' slug=article.slug %}">{{ article.title }}</a>
            </h3>
        </div>
        {% if article.summary %}
        <p class="summary">{{ article.summary }}</p>
        {% endif %}
        {% if article.tag_list %}
        <div class="tag-grid">
            {% for tag in article.tag_list %}
            <span class="tag-chip">#{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </article>
    {% endfor %}
</div>
{% else %}
<section class="card">
    <p>Журнал поки порожній. Додайте статтю через адмін-панель.</p>
</section>
{% endif %}

{% if managed_users %}
<section class="users-panel">
    <h2>Користувачі</h2>
    <table class="users-table">
        <thead>
            <tr>
                <th>Користувач</th>
                <th>Email</th>
                <th>Дата реєстрації</th>
                <th>Допуск</th>
            </tr>
        </thead>
        <tbody>
            {% for u in managed_users %}
            <tr>
                <td>{{ u.profile.display_name }}</td>
                <td>{{ u.email|default:"—" }}</td>
                <td>{{ u.date_joined|date:"d.m.Y H:i" }}</td>
                <td>
                    <button
                        class="status-toggle {% if u.is_active %}approved{% endif %}"
                        data-user-id="{{ u.pk }}"
                        data-url="{% url 'wiki:toggle_user_approved' u.pk %}"
                        type="button"
                    >
                        <span class="status-dot"></span>
                        <span class="status-text">{% if u.is_active %}Підтверджений{% else %}Очікує{% endif %}</span>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endif %}

{% if is_paginated %}
<div class="pager">
    {% if page_obj.has_previous %}
        <a class="button ghost" href="?q={{ query }}&page={{ page_obj.previous_page_number }}">Новіші</a>
    {% else %}
        <span class="muted">Початок журналу</span>
    {% endif %}
    <span class="muted">Сторінка {{ page_obj.number }} з {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
        <a class="button" href="?q={{ query }}&page={{ page_obj.next_page_number }}">Старіші</a>
    {% else %}
        <span class="muted">Кінець журналу</span>
    {% endif %}
</div>
{% endif %}

{% if managed_users %}
<script>
document.querySelectorAll('.status-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var url = btn.dataset.url;
        var csrf = '{{ csrf_token }}';
        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': csrf}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.classList.toggle('approved', data.is_approved);
            btn.querySelector('.status-text').textContent = data.is_approved ? 'Підтверджений' : 'Очікує';
        });
    });
});
</script>
{% endif %}
{% endblock %}
