{% extends "base.html" %}

{% block title %}БПЛА #{{ uav.pk }} — Майстерня{% endblock %}

{% block head %}
<style>
    .detail-hero { margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .detail-hero h1 {
        font-size: clamp(1.2rem, 3vw, 1.6rem);
        font-weight: 800; letter-spacing: -0.02em; margin: 0;
    }
    .detail-hero .badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .status-badge {
        display: inline-block; padding: 0.2rem 0.6rem;
        border-radius: 999px; font-size: 0.75rem; font-weight: 600;
        background: var(--accent-dim); color: var(--accent);
    }
    .kit-full  { background: rgba(34,197,94,0.12); color: #22c55e; }
    .kit-partial { background: rgba(245,158,11,0.12); color: #f59e0b; }
    .kit-none  { background: var(--accent-dim); color: var(--text-muted); }

    .back-link {
        display: inline-flex; align-items: center; gap: 0.35rem;
        font-size: 0.83rem; color: var(--text-muted); text-decoration: none;
        margin-bottom: 1rem; transition: color 0.15s ease;
    }
    .back-link:hover { color: var(--accent); }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem 1.5rem;
        margin-bottom: 0.25rem;
    }
    .info-row { display: flex; flex-direction: column; gap: 0.15rem; }
    .info-label {
        font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--text-muted);
    }
    .info-value { font-size: 0.88rem; color: var(--text); }

    .section-card { margin-bottom: 1.5rem; }

    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .toolbar h2 { font-size: 1rem; font-weight: 700; margin: 0; }

    .eq-table { width: 100%; border-collapse: collapse; }
    .eq-table th {
        font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--text-muted);
        padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border);
    }
    .eq-table td { padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
    .eq-table tr { transition: background 0.12s ease; }
    .eq-table tr:hover td { background: var(--accent-dim); }

    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.88rem; }

    .actions-cell { white-space: nowrap; }
    .btn-sm {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.3rem 0.65rem; border-radius: var(--radius-sm);
        font-size: 0.78rem; font-weight: 600; text-decoration: none;
        border: 1px solid var(--border); cursor: pointer;
        transition: all 0.15s ease; background: none; color: var(--text-secondary);
    }
    .btn-sm:hover { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .btn-sm.btn-danger { color: #ef4444; border-color: rgba(239,68,68,0.3); }
    .btn-sm.btn-danger:hover { background: rgba(239,68,68,0.1); color: #ef4444; border-color: #ef4444; }
    .btn-sm.btn-warn { color: #f59e0b; border-color: rgba(245,158,11,0.3); }
    .btn-sm.btn-warn:hover { background: rgba(245,158,11,0.1); color: #f59e0b; border-color: #f59e0b; }
    .btn-sm.btn-success { color: #22c55e; border-color: rgba(34,197,94,0.3); }
    .btn-sm.btn-success:hover { background: rgba(34,197,94,0.1); color: #22c55e; border-color: #22c55e; }

    .bool-yes { color: #22c55e; font-weight: 700; }
    .bool-no  { color: #ef4444; font-weight: 700; }
</style>
{% endblock %}

{% block content %}

<a href="{% url 'equipment_accounting:equipment_list' %}?tab=drones" class="back-link">
    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"/>
    </svg>
    До списку БПЛА
</a>

<div class="detail-hero">
    <h1>БПЛА #{{ uav.pk }} — {{ uav.uav_type }}</h1>
    <div class="badges">
        <span class="status-badge">{{ uav.get_status_display }}</span>
        <span class="status-badge kit-{{ kit_status }}">{{ uav.get_kit_status_display }}</span>
        <span class="status-badge">{{ uav.get_category }}</span>
    </div>
</div>

{# ── Info card ── #}
<div class="card section-card">
    <div class="toolbar">
        <h2>Характеристики</h2>
        <a href="{% url 'equipment_accounting:uav_edit' uav.pk %}" class="btn-sm">Редагувати</a>
    </div>
    {% with dt=uav.uav_type %}
    <div class="info-grid">
        <div class="info-row">
            <span class="info-label">Модель</span>
            <span class="info-value">{{ dt.model }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Призначення</span>
            <span class="info-value">{{ dt.purpose|default:"—" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Пропелери</span>
            <span class="info-value">{{ dt.get_prop_size_display }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Частоти керування</span>
            <span class="info-value">
                {% for f in dt.control_frequencies.all %}{{ f }}{% if not forloop.last %}, {% endif %}{% empty %}—{% endfor %}
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">Шаблон живлення</span>
            <span class="info-value">{{ dt.power_template }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Термальна камера</span>
            <span class="info-value">
                {% if dt.has_thermal %}<span class="bool-yes">&#10003; Є</span>{% else %}<span class="bool-no">&#10007; Немає</span>{% endif %}
            </span>
        </div>
        {# FPV-specific #}
        {% if uav.get_category == 'Радіо' %}
        <div class="info-row">
            <span class="info-label">Частота відео</span>
            <span class="info-value">{{ dt.video_frequency }}</span>
        </div>
        {% endif %}
        {# Optical-specific #}
        {% if uav.get_category == 'Оптика' %}
        <div class="info-row">
            <span class="info-label">Шаблон відео</span>
            <span class="info-value">{{ dt.video_template }}</span>
        </div>
        {% endif %}
        <div class="info-row">
            <span class="info-label">Поточна локація</span>
            <span class="info-value">{{ uav.current_location.name|default:"—" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Призначення</span>
            <span class="info-value">{{ uav.role.name|default:"—" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Додав</span>
            <span class="info-value">{% if uav.created_by %}{{ uav.created_by.profile.display_name }}{% else %}—{% endif %}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Дата</span>
            <span class="info-value">{{ uav.created_at|date:"d.m.Y" }}</span>
        </div>
    </div>
    {% if uav.notes %}
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="info-label" style="margin-bottom: 0.3rem;">Примітки</div>
        <div class="info-value" style="white-space: pre-wrap;">{{ uav.notes }}</div>
    </div>
    {% endif %}
    {% endwith %}
</div>

{# ── Assigned components ── #}
<div class="card section-card">
    <div class="toolbar">
        <h2>Закріплені комплектуючі</h2>
    </div>
    {% if assigned_components %}
    <table class="eq-table">
        <thead>
            <tr>
                <th>Тип комплектуючої</th>
                <th>Статус</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for comp in assigned_components %}
            <tr>
                <td>{{ comp.type_display }}</td>
                <td><span class="status-badge">{{ comp.get_status_display }}</span></td>
                <td class="actions-cell">
                    <form method="post" action="{% url 'equipment_accounting:component_mark_damaged' comp.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'equipment_accounting:uav_detail' uav.pk %}">
                        <button type="submit" class="btn-sm btn-warn">Пошкоджено</button>
                    </form>
                    <form method="post" action="{% url 'equipment_accounting:uav_detach_component' uav.pk comp.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-sm btn-danger">Відкріпити</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">Комплектуючих ще не закріплено.</div>
    {% endif %}
</div>

{# ── Free components (hidden when UAV is fully kitted) ── #}
{% if kit_status != 'full' %}
<div class="card section-card">
    <div class="toolbar">
        <h2>Вільні комплектуючі</h2>
    </div>
    {% if free_components %}
    <table class="eq-table">
        <thead>
            <tr>
                <th>Тип комплектуючої</th>
                <th>Статус</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for comp in free_components %}
            <tr>
                <td>{{ comp.type_display }}</td>
                <td><span class="status-badge">{{ comp.get_status_display }}</span></td>
                <td class="actions-cell">
                    <form method="post" action="{% url 'equipment_accounting:uav_attach_component' uav.pk comp.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-sm btn-success">Закріпити</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">Вільних комплектуючих немає.</div>
    {% endif %}
</div>
{% endif %}

{# ── Movement history ── #}
<div class="card section-card">
    <div class="toolbar">
        <h2>Історія переміщень</h2>
    </div>
    {% if movements %}
    <table class="eq-table">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Подія</th>
                <th>Звідки</th>
                <th>Куди</th>
                <th>Хто</th>
            </tr>
        </thead>
        <tbody>
            {% for m in movements %}
            <tr>
                <td style="white-space:nowrap; color:var(--text-secondary);">{{ m.created_at|date:"d.m.Y H:i" }}</td>
                <td>{{ m.get_reason_display }}</td>
                <td>{{ m.from_location.name|default:"—" }}</td>
                <td>{{ m.to_location.name }}</td>
                <td>{% if m.moved_by %}{{ m.moved_by.profile.display_name }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">Переміщень ще не зафіксовано.</div>
    {% endif %}
</div>

{% endblock %}
