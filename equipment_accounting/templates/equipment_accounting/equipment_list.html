{% extends "base.html" %}

{% block title %}Облік майна — Майстерня{% endblock %}

{% block head %}
<style>
    .eq-hero { margin-bottom: 1.5rem; }
    .eq-hero h1 {
        font-size: clamp(1.3rem, 3vw, 1.7rem);
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 0.25rem;
    }
    .eq-hero p { color: var(--text-secondary); font-size: 0.9rem; }

    /* tabs */
    .tab-bar {
        display: flex; gap: 0.25rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }
    .tab-btn {
        padding: 0.65rem 1.2rem; border: none; background: none;
        color: var(--text-muted); font-size: 0.85rem; font-weight: 600;
        cursor: pointer; position: relative; transition: color 0.15s ease;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--accent); }
    .tab-btn.active::after {
        content: ''; position: absolute;
        left: 0; right: 0; bottom: -1px; height: 2px;
        background: var(--accent); border-radius: 2px 2px 0 0;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem; margin-bottom: 1.5rem;
    }
    .summary-card {
        background: var(--surface); backdrop-filter: blur(20px);
        border-radius: var(--radius); padding: 1.25rem;
        border: 1px solid var(--border); box-shadow: var(--shadow-card);
        transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .summary-card:hover { box-shadow: var(--shadow-elevated); border-color: var(--border-active); }
    .summary-label {
        font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.35rem;
    }
    .summary-value { font-size: 1.4rem; font-weight: 800; color: var(--accent); }

    .filter-bar {
        display: flex; gap: 0.75rem; margin-bottom: 1rem;
        flex-wrap: wrap; align-items: center;
    }
    .filter-bar select, .filter-bar input {
        padding: 0.55rem 0.75rem; border: 1px solid var(--border);
        border-radius: var(--radius-sm); background: var(--input-bg);
        color: var(--text); font-size: 0.85rem; font-family: inherit;
        outline: none; transition: border-color 0.2s ease;
    }
    .filter-bar select:focus, .filter-bar input:focus {
        border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim);
    }
    .filter-bar input[type="text"] { flex: 1; min-width: 150px; }
    .filter-bar input[type="date"] { width: auto; }
    .btn-reset-filter {
        padding: 0.55rem 0.75rem; font-size: 0.82rem; font-weight: 600;
        color: var(--text-muted); text-decoration: none; white-space: nowrap;
        border: 1px solid var(--border); border-radius: var(--radius-sm);
        transition: color 0.15s ease, border-color 0.15s ease;
    }
    .btn-reset-filter:hover { color: #ef4444; border-color: rgba(239,68,68,0.4); }
    .date-field {
        display: flex; flex-direction: column; gap: 0.15rem;
    }
    .date-label {
        font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.05em; color: var(--text-muted); line-height: 1;
    }

    .toolbar {
        display: flex; justify-content: space-between;
        align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;
    }
    .toolbar h2 { font-size: 1rem; font-weight: 700; margin: 0; }

    /* Export column chooser */
    .export-wrap { position: relative; }
    .export-panel {
        display: none; position: absolute; right: 0; top: calc(100% + 6px);
        z-index: 50; min-width: 240px;
        background: var(--surface); border: 1px solid var(--border);
        border-radius: var(--radius-sm); box-shadow: var(--shadow-elevated);
        padding: 0.75rem 1rem 1rem;
    }
    .export-panel.open { display: block; }
    .export-panel-title {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.6rem;
    }
    .export-col-list {
        display: flex; flex-direction: column; gap: 0.35rem; margin-bottom: 0.85rem;
    }
    .export-col-list label {
        display: flex; align-items: center; gap: 0.5rem;
        font-size: 0.83rem; cursor: pointer; color: var(--text-secondary);
    }
    .export-col-list input[type="checkbox"] { accent-color: var(--accent); }
    .btn-export-dl {
        width: 100%; padding: 0.55rem; font-size: 0.82rem; font-weight: 600;
        border: none; border-radius: var(--radius-sm);
        background: var(--btn-bg); color: var(--btn-text); cursor: pointer;
    }

    .eq-table { width: 100%; border-collapse: collapse; }
    .eq-table th {
        font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--text-muted);
        padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border);
    }
    .eq-table td {
        padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.88rem;
    }
    .eq-table tr { transition: background 0.12s ease; }
    .eq-table tr:hover td { background: var(--accent-dim); }

    .status-badge {
        display: inline-block; padding: 0.2rem 0.6rem;
        border-radius: 999px; font-size: 0.75rem; font-weight: 600;
        background: var(--accent-dim); color: var(--accent);
    }
    .status-badge.given { background: rgba(148,163,184,0.15); color: #94a3b8; }
    .date-cell { white-space: nowrap; color: var(--text-secondary); }
    .kit-full { color: #22c55e; font-weight: 600; }
    .kit-partial { color: #f59e0b; font-weight: 600; }
    .kit-none { color: var(--text-muted); }
    .bool-yes { color: #22c55e; font-weight: 700; }
    .bool-no { color: #ef4444; font-weight: 700; }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }

    /* Action buttons */
    .actions-cell { white-space: nowrap; display: flex; gap: 0.4rem; }
    .btn-sm {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.35rem 0.7rem; border-radius: var(--radius-sm);
        font-size: 0.78rem; font-weight: 600; text-decoration: none;
        border: 1px solid var(--border); cursor: pointer;
        transition: all 0.15s ease; background: none; color: var(--text-secondary);
    }
    .btn-sm:hover { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .btn-sm.btn-danger { color: #ef4444; border-color: rgba(239,68,68,0.3); }
    .btn-sm.btn-danger:hover { background: rgba(239,68,68,0.1); color: #ef4444; border-color: #ef4444; }
    .btn-sm.btn-warn { color: #f59e0b; border-color: rgba(245,158,11,0.3); }
    .btn-sm.btn-warn:hover { background: rgba(245,158,11,0.1); color: #f59e0b; border-color: #f59e0b; }

    .btn-icon {
        display: inline-flex; align-items: center; justify-content: center;
        width: 32px; height: 32px; border-radius: var(--radius-sm);
        overflow: visible;
        border: 1px solid var(--border); text-decoration: none; background: none;
        color: var(--text-secondary); transition: all 0.15s ease; cursor: pointer;
        position: relative;
    }
    .btn-icon:hover { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .btn-icon-danger { color: #ef4444; border-color: rgba(239,68,68,0.3); }
    .btn-icon-danger:hover { background: rgba(239,68,68,0.1); color: #ef4444; border-color: #ef4444; }
    .btn-icon-warn { color: #f59e0b; border-color: rgba(245,158,11,0.3); }
    .btn-icon-warn:hover { background: rgba(245,158,11,0.1); color: #f59e0b; border-color: #f59e0b; }
    .btn-icon-success { color: #22c55e; border-color: rgba(34,197,94,0.3); }
    .btn-icon-success:hover { background: rgba(34,197,94,0.1); color: #22c55e; border-color: #22c55e; }
    /* Tooltip */
    .btn-icon[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
        background: var(--bg-sub); color: var(--text);
        border: 1px solid var(--border); border-radius: var(--radius-sm);
        padding: 0.2rem 0.5rem; font-size: 0.72rem; white-space: nowrap;
        pointer-events: none; z-index: 100;
    }

    /* Checkboxes */
    .row-check, .check-all {
        width: 1rem; height: 1rem; accent-color: var(--accent); cursor: pointer;
    }
    .th-check { width: 40px; }

    /* Bulk bar */
    .bulk-bar {
        display: none; align-items: center; gap: 0.75rem;
        padding: 0.75rem 1rem; margin-bottom: 1rem;
        background: var(--accent-dim); border: 1px solid var(--border-active);
        border-radius: var(--radius-sm); flex-wrap: wrap;
    }
    .bulk-bar.visible { display: flex; }
    .bulk-bar .bulk-count {
        font-size: 0.85rem; font-weight: 600; color: var(--accent);
        margin-right: auto;
    }
    .bulk-bar select {
        padding: 0.4rem 0.6rem; border: 1px solid var(--border);
        border-radius: var(--radius-sm); background: var(--input-bg);
        color: var(--text); font-size: 0.82rem; font-family: inherit; outline: none;
    }
    .bulk-bar .btn-sm { padding: 0.4rem 0.8rem; }

    /* Pagination */
    .pagination {
        display: flex; justify-content: center; align-items: center;
        gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap;
    }
    .pagination a, .pagination span {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 36px; height: 36px; padding: 0 0.5rem;
        border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 500;
        text-decoration: none; border: 1px solid var(--border);
        color: var(--text-secondary); transition: all 0.15s ease;
    }
    .pagination a:hover { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .pagination .current {
        background: var(--accent); color: var(--btn-text);
        border-color: var(--accent); font-weight: 700;
    }
    .pagination .disabled { opacity: 0.4; pointer-events: none; }

    @media (max-width: 640px) {
        .eq-table thead { display: none; }
        .eq-table tr { display: block; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .eq-table td {
            display: flex; justify-content: space-between;
            padding: 0.25rem 0; border: none;
        }
        .eq-table td::before {
            content: attr(data-label); font-weight: 600;
            font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-muted);
        }
    }

    /* Badge / card view */
    .badge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem; margin-top: 1rem;
    }
    .drone-badge {
        background: var(--surface); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 1.1rem 1.25rem;
        box-shadow: var(--shadow-card);
        display: flex; flex-direction: column; gap: 0.6rem;
        transition: box-shadow 0.2s, border-color 0.2s;
        text-decoration: none; color: inherit; cursor: pointer;
    }
    .drone-badge:hover { box-shadow: var(--shadow-elevated); border-color: var(--border-active); }
    .badge-top { display: flex; align-items: center; justify-content: space-between; gap: 0.4rem; }
    .cat-chip {
        display: inline-block; padding: 0.18rem 0.55rem; border-radius: 999px;
        font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
    }
    .cat-chip-radio   { background: rgba(59,130,246,.15); color: #3b82f6; }
    .cat-chip-optical { background: rgba(34,197,94,.15);  color: #22c55e; }
    .badge-date { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; }
    .badge-type { font-size: 0.88rem; font-weight: 700; color: var(--text); line-height: 1.3; }
    .badge-count { font-size: 2rem; font-weight: 800; color: var(--accent); line-height: 1; }
    .badge-statuses { display: flex; flex-wrap: wrap; gap: 0.3rem; }
    .st-pill {
        display: inline-block; padding: 0.15rem 0.5rem;
        border-radius: 999px; font-size: 0.7rem; font-weight: 600; white-space: nowrap;
    }
    .st-ready      { background: rgba(34,197,94,.15);   color: #22c55e; }
    .st-inspection { background: rgba(59,130,246,.15);  color: #3b82f6; }
    .st-repair     { background: rgba(245,158,11,.15);  color: #f59e0b; }
    .st-deferred   { background: rgba(148,163,184,.15); color: #94a3b8; }
    .st-given      { background: rgba(148,163,184,.1);  color: #94a3b8; }

    /* Expandable group rows */
    .group-detail-row > td { padding: 0; border-bottom: 2px solid var(--border); }
    .group-uavs-inner { background: var(--bg-sub, var(--surface)); }
    .group-uav-row td { padding: 0.6rem 0.75rem; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
    .group-uav-row:last-child td { border-bottom: none; }
    .group-uav-row:hover td { background: var(--accent-dim); }
    .expand-btn svg { transition: transform 0.2s ease; }
    .expand-btn.open svg { transform: rotate(90deg); }

    /* View toggle active state */
    .btn-icon.view-active {
        background: var(--accent-dim); color: var(--accent); border-color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000;
        opacity: 0; visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-box {
        background: var(--surface); border: 1px solid var(--border);
        border-radius: var(--radius); box-shadow: var(--shadow-elevated);
        padding: 1.5rem; max-width: 400px; width: 90%;
        transform: scale(0.9); transition: transform 0.2s ease;
    }
    .modal-overlay.visible .modal-box { transform: scale(1); }
    .modal-box h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
    .modal-box p { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.25rem; }
    .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
    .modal-actions button {
        padding: 0.5rem 1rem; border-radius: var(--radius-sm);
        font-size: 0.85rem; font-weight: 600; cursor: pointer;
        transition: background 0.15s ease;
    }
    .modal-actions .btn-cancel {
        border: 1px solid var(--border); background: none; color: var(--text);
    }
    .modal-actions .btn-cancel:hover { background: var(--accent-dim); }
    .modal-actions .btn-confirm-danger {
        border: none; background: #ef4444; color: #fff;
    }
    .modal-actions .btn-confirm-danger:hover { background: #dc2626; }
    .modal-actions .btn-confirm-warn {
        border: none; background: var(--accent); color: var(--btn-text);
    }
    .modal-actions .btn-confirm-warn:hover { opacity: 0.9; }
</style>
{% endblock %}

{% block content %}
<div class="eq-hero">
    <h1>Облік майна</h1>
    <p>Дрони, комплектуючі та шаблони обладнання</p>
</div>

<div class="tab-bar">
    <button class="tab-btn{% if tab == 'drones' %} active{% endif %}" type="button" data-tab="drones">БПЛА</button>
    <button class="tab-btn{% if tab == 'components' %} active{% endif %}" type="button" data-tab="components">Комплектуючі</button>
    <button class="tab-btn{% if tab == 'types' %} active{% endif %}" type="button" data-tab="types">Типи БПЛА</button>
    <button class="tab-btn{% if tab == 'templates' %} active{% endif %}" type="button" data-tab="templates">Шаблони</button>
</div>

{# ── Tab: Drones ── #}
<div class="tab-panel{% if tab == 'drones' %} active{% endif %}" id="tab-drones">
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Всього БПЛА</div>
            <div class="summary-value">{{ total_drones }}</div>
        </div>
        {% for code, info in status_counts.items %}
        <div class="summary-card">
            <div class="summary-label">{{ info.label }}</div>
            <div class="summary-value">{{ info.count }}</div>
        </div>
        {% endfor %}
    </div>

    <div class="card">
        <div class="toolbar">
            <h2>БПЛА <span style="font-weight:400;color:var(--text-muted);font-size:0.85rem;">· {{ page_obj.paginator.count }}</span></h2>
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <button type="button" class="btn-icon" id="view-table-btn" data-tooltip="Таблиця">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                </button>
                <button type="button" class="btn-icon" id="view-badge-btn" data-tooltip="Картки">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                </button>
                <div class="export-wrap">
                    <button type="button" class="button ghost" id="export-toggle-btn">Excel ↓</button>
                    <div class="export-panel" id="export-panel">
                        <div class="export-panel-title">Колонки</div>
                        <div class="export-col-list">
                            <label><input type="checkbox" name="xcol" value="name" checked> Назва</label>
                            <label><input type="checkbox" name="xcol" value="count" checked> В наявності</label>
                            <label><input type="checkbox" name="xcol" value="unit" checked> шт</label>
                            <label><input type="checkbox" name="xcol" value="messenger" checked> Для мессенджера</label>
                            <label><input type="checkbox" name="xcol" value="new" checked> Нові</label>
                            <label><input type="checkbox" name="xcol" value="repair" checked> В ремонті</label>
                            <label><input type="checkbox" name="xcol" value="mfr_repair" checked> В ремонті у виробника</label>
                            <label><input type="checkbox" name="xcol" value="total" checked> Підсумок</label>
                        </div>
                        <button type="button" class="btn-export-dl" id="export-dl-btn">Завантажити</button>
                    </div>
                </div>
                <a href="{% url 'equipment_accounting:uav_create' %}" class="button">+ Додати</a>
            </div>
        </div>

        <form method="get" class="filter-bar">
            <input type="hidden" name="tab" value="drones">
            <select name="status">
                <option value="">Всі статуси</option>
                {% for code, label in status_choices %}
                <option value="{{ code }}"{% if status_filter == code %} selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <select name="category">
                <option value="">Всі категорії</option>
                <option value="fpv"{% if category_filter == 'fpv' %} selected{% endif %}>Радіо</option>
                <option value="optical"{% if category_filter == 'optical' %} selected{% endif %}>Оптика</option>
            </select>
            <select name="type">
                <option value="">Всі типи</option>
                {% for val, label in type_choices %}
                <option value="{{ val }}"{% if type_filter == val %} selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <select name="kit">
                <option value="">Комплект</option>
                {% for code, label in kit_choices %}
                <option value="{{ code }}"{% if kit_filter == code %} selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <select name="location">
                <option value="">Всі локації</option>
                {% for loc in locations %}
                <option value="{{ loc.pk }}"{% if location_filter == loc.pk %} selected{% endif %}>{{ loc.name }}</option>
                {% endfor %}
            </select>
            <div class="date-field">
                <label class="date-label">Дата від</label>
                <input type="date" name="date_from" value="{{ date_from }}">
            </div>
            <div class="date-field">
                <label class="date-label">Дата до</label>
                <input type="date" name="date_to" value="{{ date_to }}">
            </div>
            {% if status_filter or category_filter or type_filter or kit_filter or location_filter or date_from or date_to %}
            <a href="?tab=drones" class="btn-reset-filter">&#10005; Скинути</a>
            {% endif %}
        </form>

        {# ── Badge view ── #}
        <div id="uav-badge-view" style="display:none;">
            {% if badge_groups %}
            <div class="badge-grid">
                {% for group in badge_groups %}
                <a href="?tab=drones&type={{ group.type_key }}&date_from={{ group.date_str }}&date_to={{ group.date_str }}" class="drone-badge">
                    <div class="badge-top">
                        <span class="cat-chip {% if group.category == 'Радіо' %}cat-chip-radio{% else %}cat-chip-optical{% endif %}">{{ group.category }}</span>
                        <span class="badge-date">{{ group.date|date:"d.m.Y" }}</span>
                    </div>
                    <div class="badge-type">{{ group.type_label }}</div>
                    <div class="badge-count">{{ group.total }}</div>
                    <div class="badge-statuses">
                        {% for status, label, count in group.status_items %}
                        <span class="st-pill st-{{ status }}">{{ count }} {{ label }}</span>
                        {% endfor %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state"><p>БПЛА ще не додано.</p></div>
            {% endif %}
        </div>

        {# ── Table view ── #}
        <div id="uav-table-view">
            <table class="eq-table">
                <thead>
                    <tr>
                        <th>Категорія</th>
                        <th>Тип БПЛА</th>
                        <th>Дата партії</th>
                        <th style="text-align:center;">Всього</th>
                        <th style="text-align:center;color:#22c55e;">Готових</th>
                        <th style="text-align:center;color:#3b82f6;">Перевірка</th>
                        <th style="text-align:center;color:#f59e0b;">Ремонт</th>
                        <th style="text-align:center;color:#94a3b8;">Відкладено</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in badge_groups %}
                    <tr class="group-row">
                        <td data-label="Категорія">
                            <span class="cat-chip {% if group.category == 'Радіо' %}cat-chip-radio{% else %}cat-chip-optical{% endif %}">{{ group.category }}</span>
                        </td>
                        <td data-label="Тип БПЛА">{{ group.type_label }}</td>
                        <td data-label="Дата партії" class="date-cell">{{ group.date|date:"d.m.Y" }}</td>
                        <td data-label="Всього" style="text-align:center;font-weight:700;">{{ group.total }}</td>
                        <td data-label="Готових"    style="text-align:center;color:#22c55e;font-weight:600;">{% if group.cnt_ready %}{{ group.cnt_ready }}{% else %}<span style="color:var(--text-muted)">—</span>{% endif %}</td>
                        <td data-label="Перевірка"  style="text-align:center;color:#3b82f6;font-weight:600;">{% if group.cnt_inspection %}{{ group.cnt_inspection }}{% else %}<span style="color:var(--text-muted)">—</span>{% endif %}</td>
                        <td data-label="Ремонт"     style="text-align:center;color:#f59e0b;font-weight:600;">{% if group.cnt_repair %}{{ group.cnt_repair }}{% else %}<span style="color:var(--text-muted)">—</span>{% endif %}</td>
                        <td data-label="Відкладено" style="text-align:center;color:#94a3b8;font-weight:600;">{% if group.cnt_deferred %}{{ group.cnt_deferred }}{% else %}<span style="color:var(--text-muted)">—</span>{% endif %}</td>
                        <td data-label="" class="actions-cell">
                            <button type="button" class="btn-icon expand-btn" data-target="grp-{{ forloop.counter0 }}" data-tooltip="Показати дрони">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                            </button>
                        </td>
                    </tr>
                    <tr class="group-detail-row" id="grp-{{ forloop.counter0 }}" style="display:none;">
                        <td colspan="9">
                            <div class="group-uavs-inner">
                                <table class="eq-table" style="margin:0;">
                                    <thead>
                                        <tr>
                                            <th style="width:40px;">#</th>
                                            <th>Статус</th>
                                            <th>Призначення</th>
                                            <th>Комплект</th>
                                            <th>Локація</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for uav in group.uavs %}
                                        <tr class="group-uav-row">
                                            <td style="color:var(--text-muted);font-size:0.8rem;">{{ uav.id }}</td>
                                            <td><span class="status-badge{% if uav.status == 'given' %} given{% endif %}">{{ uav.get_status_display }}</span></td>
                                            <td>{{ uav.role.name|default:"—" }}</td>
                                            <td><span class="kit-{{ uav.get_kit_status }}">{{ uav.get_kit_status_display }}</span></td>
                                            <td>{{ uav.current_location.name|default:"—" }}</td>
                                            <td class="actions-cell">
                                                <a href="{% url 'equipment_accounting:uav_detail' uav.pk %}" class="btn-icon" data-tooltip="Деталі">
                                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                                </a>
                                                {% if uav.status == 'ready' %}
                                                <button type="button" class="btn-icon btn-icon-success" data-tooltip="Віддати"
                                                    data-give-url="{% url 'equipment_accounting:uav_toggle_given' uav.pk %}"
                                                    onclick="openGiveModal(this.dataset.giveUrl)">
                                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                                                </button>
                                                {% endif %}
                                                <a href="{% url 'equipment_accounting:uav_edit' uav.pk %}" class="btn-icon" data-tooltip="Редагувати">
                                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                </a>
                                                <a href="{% url 'equipment_accounting:uav_delete' uav.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9"><div class="empty-state"><p>БПЛА ще не додано.</p></div></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>{# /uav-table-view #}
    </div>
</div>

<script>
(function () {
    var STORAGE_KEY = 'uav_view_mode';
    var tableView = document.getElementById('uav-table-view');
    var badgeView = document.getElementById('uav-badge-view');
    var tableBtn  = document.getElementById('view-table-btn');
    var badgeBtn  = document.getElementById('view-badge-btn');
    if (!tableBtn) return;

    function setView(mode) {
        if (mode === 'badge') {
            tableView.style.display = 'none';
            badgeView.style.display = '';
            tableBtn.classList.remove('view-active');
            badgeBtn.classList.add('view-active');
        } else {
            tableView.style.display = '';
            badgeView.style.display = 'none';
            tableBtn.classList.add('view-active');
            badgeBtn.classList.remove('view-active');
        }
        try { localStorage.setItem(STORAGE_KEY, mode); } catch (e) {}
    }

    tableBtn.addEventListener('click', function () { setView('table'); });
    badgeBtn.addEventListener('click', function () { setView('badge'); });

    var saved = 'table';
    try { saved = localStorage.getItem(STORAGE_KEY) || 'table'; } catch (e) {}
    setView(saved);

    // Expand / collapse group rows
    document.querySelectorAll('.expand-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var target = document.getElementById(btn.dataset.target);
            if (!target) return;
            var open = target.style.display !== 'none';
            target.style.display = open ? 'none' : '';
            btn.classList.toggle('open', !open);
            btn.setAttribute('data-tooltip', open ? 'Показати дрони' : 'Сховати дрони');
        });
    });
})();
</script>

{# ── Tab: Components ── #}
<div class="tab-panel{% if tab == 'components' %} active{% endif %}" id="tab-components">
    <div class="card">
        <div class="toolbar">
            <h2>Комплектуючі <span style="font-weight:400;color:var(--text-muted);font-size:0.85rem;">· {{ comp_page_obj.paginator.count }}</span></h2>
            <a href="{% url 'equipment_accounting:component_create' %}" class="button">+ Додати</a>
        </div>

        <form method="get" class="filter-bar" id="comp-filter-form">
            <input type="hidden" name="tab" value="components">
            <select name="comp_status">
                <option value="">Всі статуси</option>
                <option value="in_use"{% if comp_status_filter == 'in_use' %} selected{% endif %}>Використовується</option>
                <option value="damaged"{% if comp_status_filter == 'damaged' %} selected{% endif %}>Пошкоджено</option>
                <option value="disassembled"{% if comp_status_filter == 'disassembled' %} selected{% endif %}>Розкомплектовано</option>
            </select>
            <select name="comp_category">
                <option value="">Всі типи</option>
                <option value="battery"{% if comp_category_filter == 'battery' %} selected{% endif %}>Батарея</option>
                <option value="spool"{% if comp_category_filter == 'spool' %} selected{% endif %}>Котушка</option>
                <option value="other"{% if comp_category_filter == 'other' %} selected{% endif %}>Інше</option>
            </select>
            <select name="comp_assign">
                <option value="">Всі</option>
                <option value="assigned"{% if comp_assign_filter == 'assigned' %} selected{% endif %}>Закріплені</option>
                <option value="free"{% if comp_assign_filter == 'free' %} selected{% endif %}>Вільні</option>
            </select>
            <select name="comp_model">
                <option value="">Всі моделі</option>
                {% for dm in drone_models %}
                <option value="{{ dm.pk }}"{% if comp_model_filter == dm.pk|stringformat:"s" %} selected{% endif %}>{{ dm }}</option>
                {% endfor %}
            </select>
            <select name="comp_drone_type">
                <option value="">Радіо/Оптика</option>
                <option value="fpv"{% if comp_drone_type_filter == 'fpv' %} selected{% endif %}>Радіо</option>
                <option value="optical"{% if comp_drone_type_filter == 'optical' %} selected{% endif %}>Оптика</option>
            </select>
            <a href="?tab=components" class="btn-reset-filter">&#10005; Скинути</a>
        </form>

        {% if comp_page_obj %}
        <form method="post" action="{% url 'equipment_accounting:component_bulk_action' %}" id="comp-bulk-form">
            {% csrf_token %}

            <div class="bulk-bar" id="comp-bulk-bar">
                <span class="bulk-count">Обрано: <span id="comp-bulk-count-num">0</span></span>
                <button type="submit" class="btn-sm btn-danger" id="comp-bulk-submit">Видалити</button>
            </div>

        <table class="eq-table">
            <thead>
                <tr>
                    <th class="th-check"><input type="checkbox" class="check-all" id="comp-check-all"></th>
                    <th>Тип</th>
                    <th>Статус</th>
                    <th>Закріплена за</th>
                    <th>Дата</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for c in comp_page_obj %}
                <tr>
                    <td><input type="checkbox" name="selected" value="{{ c.pk }}" class="comp-row-check"></td>
                    <td data-label="Тип">{{ c }}</td>
                    <td data-label="Статус"><span class="status-badge">{{ c.get_status_display }}</span></td>
                    <td data-label="Закріплена за">{{ c.assigned_to_uav|default:"—" }}</td>
                    <td data-label="Дата" class="date-cell">{{ c.created_at|date:"d.m.Y" }}</td>
                    <td data-label="" class="actions-cell">
                        {# Edit #}
                        <a href="{% url 'equipment_accounting:component_edit' c.pk %}" class="btn-icon" data-tooltip="Редагувати">
                            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </a>
                        {# Mark damaged — hidden if already damaged #}
                        {% if c.status != 'damaged' %}
                        <form method="post" action="{% url 'equipment_accounting:component_mark_damaged' c.pk %}" style="display:contents;">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn-icon btn-icon-warn" data-tooltip="Пошкоджено">
                                <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </button>
                        </form>
                        {% endif %}
                        {# Restore — shown when damaged or disassembled #}
                        {% if c.status != 'in_use' %}
                        <form method="post" action="{% url 'equipment_accounting:component_restore' c.pk %}" style="display:contents;">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn-icon btn-icon-success" data-tooltip="Відновити">
                                <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
                            </button>
                        </form>
                        {% endif %}
                        {# Delete #}
                        <a href="{% url 'equipment_accounting:component_delete' c.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if comp_page_obj.paginator.num_pages > 1 %}
        <div class="pagination">
            {% if comp_page_obj.has_previous %}
            <a href="?tab=components&comp_status={{ comp_status_filter }}&comp_category={{ comp_category_filter }}&comp_assign={{ comp_assign_filter }}&comp_model={{ comp_model_filter }}&comp_drone_type={{ comp_drone_type_filter }}&cpage={{ comp_page_obj.previous_page_number }}">Попередня</a>
            {% else %}
            <span class="disabled">Попередня</span>
            {% endif %}

            {% for num in comp_page_obj.paginator.page_range %}
                {% if comp_page_obj.number == num %}
                <span class="current">{{ num }}</span>
                {% elif num > comp_page_obj.number|add:"-3" and num < comp_page_obj.number|add:"3" %}
                <a href="?tab=components&comp_status={{ comp_status_filter }}&comp_category={{ comp_category_filter }}&comp_assign={{ comp_assign_filter }}&comp_model={{ comp_model_filter }}&comp_drone_type={{ comp_drone_type_filter }}&cpage={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if comp_page_obj.has_next %}
            <a href="?tab=components&comp_status={{ comp_status_filter }}&comp_category={{ comp_category_filter }}&comp_assign={{ comp_assign_filter }}&comp_model={{ comp_model_filter }}&comp_drone_type={{ comp_drone_type_filter }}&cpage={{ comp_page_obj.next_page_number }}">Наступна</a>
            {% else %}
            <span class="disabled">Наступна</span>
            {% endif %}
        </div>
        {% endif %}

        </form>
        {% else %}
        <div class="empty-state"><p>Комплектуючих ще немає.</p></div>
        {% endif %}
    </div>
</div>

{# ── Tab: Drone Types ── #}
<div class="tab-panel{% if tab == 'types' %} active{% endif %}" id="tab-types">

    {# Manufacturers #}
    <div class="card">
        <div class="toolbar">
            <h2>Виробники</h2>
            <a href="{% url 'equipment_accounting:manufacturer_create' %}" class="button">+ Додати</a>
        </div>
        {% if manufacturers %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Назва</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for m in manufacturers %}
                <tr>
                    <td data-label="Назва">{{ m.name }}</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:manufacturer_edit' m.pk %}" class="btn-icon" data-tooltip="Редагувати">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </a>
                        <a href="{% url 'equipment_accounting:manufacturer_delete' m.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Виробників ще немає.</p></div>
        {% endif %}
    </div>

    {# Drone models #}
    <div class="card">
        <div class="toolbar">
            <h2>Моделі дронів</h2>
            <a href="{% url 'equipment_accounting:drone_model_create' %}" class="button">+ Додати</a>
        </div>
        {% if drone_models %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Назва</th>
                    <th>Виробник</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for dm in drone_models %}
                <tr>
                    <td data-label="Назва">{{ dm.name }}</td>
                    <td data-label="Виробник">{{ dm.manufacturer }}</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:drone_model_edit' dm.pk %}" class="btn-icon" data-tooltip="Редагувати">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </a>
                        <a href="{% url 'equipment_accounting:drone_model_delete' dm.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Моделей дронів ще немає.</p></div>
        {% endif %}
    </div>

    {# FPV drone types #}
    <div class="card">
        <div class="toolbar">
            <h2>Типи радіо дронів</h2>
            <a href="{% url 'equipment_accounting:fpv_type_create' %}" class="button">+ Додати</a>
        </div>

        {% if fpv_drone_types %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Модель</th>
                    <th>Призначення</th>
                    <th>Пропелери</th>
                    <th>Частота керування</th>
                    <th>Частота відео</th>
                    <th>Живлення</th>
                    <th>Термал</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for dt in fpv_drone_types %}
                <tr>
                    <td data-label="Модель">{{ dt.model }}</td>
                    <td data-label="Призначення">{{ dt.purpose|default:"—" }}</td>
                    <td data-label="Пропелери">{{ dt.get_prop_size_display }}</td>
                    <td data-label="Частота керування">{% for f in dt.control_frequencies.all %}{{ f }}{% if not forloop.last %}, {% endif %}{% empty %}—{% endfor %}</td>
                    <td data-label="Частота відео">{{ dt.video_frequency }}</td>
                    <td data-label="Живлення">{{ dt.power_template }}</td>
                    <td data-label="Термал">{% if dt.has_thermal %}<span class="bool-yes">&#10003;</span>{% else %}<span class="bool-no">&#10007;</span>{% endif %}</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:fpv_type_edit' dt.pk %}" class="btn-icon" data-tooltip="Редагувати">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </a>
                        <a href="{% url 'equipment_accounting:fpv_type_delete' dt.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Типів радіо дронів ще немає.</p></div>
        {% endif %}
    </div>

    {# Optical drone types #}
    <div class="card">
        <div class="toolbar">
            <h2>Типи оптичних дронів</h2>
            <a href="{% url 'equipment_accounting:optical_type_create' %}" class="button">+ Додати</a>
        </div>

        {% if optical_drone_types %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Модель</th>
                    <th>Призначення</th>
                    <th>Пропелери</th>
                    <th>Частота керування</th>
                    <th>Шаблон відео</th>
                    <th>Живлення</th>
                    <th>Термал</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for dt in optical_drone_types %}
                <tr>
                    <td data-label="Модель">{{ dt.model }}</td>
                    <td data-label="Призначення">{{ dt.purpose|default:"—" }}</td>
                    <td data-label="Пропелери">{{ dt.get_prop_size_display }}</td>
                    <td data-label="Частота керування">{% for f in dt.control_frequencies.all %}{{ f }}{% if not forloop.last %}, {% endif %}{% empty %}—{% endfor %}</td>
                    <td data-label="Шаблон відео">{{ dt.video_template }}</td>
                    <td data-label="Живлення">{{ dt.power_template }}</td>
                    <td data-label="Термал">{% if dt.has_thermal %}<span class="bool-yes">&#10003;</span>{% else %}<span class="bool-no">&#10007;</span>{% endif %}</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:optical_type_edit' dt.pk %}" class="btn-icon" data-tooltip="Редагувати">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </a>
                        <a href="{% url 'equipment_accounting:optical_type_delete' dt.pk %}" class="btn-icon btn-icon-danger" data-tooltip="Видалити">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Типів оптичних дронів ще немає.</p></div>
        {% endif %}
    </div>
</div>

{# ── Tab: Templates ── #}
<div class="tab-panel{% if tab == 'templates' %} active{% endif %}" id="tab-templates">

    {# Power templates #}
    <div class="card">
        <div class="toolbar">
            <h2>Шаблони живлення</h2>
            <a href="{% url 'equipment_accounting:power_template_create' %}" class="button">+ Додати</a>
        </div>

        {% if power_templates %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Назва</th>
                    <th>Конектор</th>
                    <th>Конфігурація</th>
                    <th>Ємність</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for pt in power_templates %}
                <tr>
                    <td data-label="Назва">{{ pt.name }}</td>
                    <td data-label="Конектор">{{ pt.get_connector_display }}</td>
                    <td data-label="Конфігурація">{{ pt.get_configuration_display }}</td>
                    <td data-label="Ємність">{{ pt.capacity }} mAh</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:power_template_edit' pt.pk %}" class="btn-sm">Редагувати</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Шаблонів живлення немає.</p></div>
        {% endif %}
    </div>

    {# Video templates #}
    <div class="card">
        <div class="toolbar">
            <h2>Шаблони відео</h2>
            <a href="{% url 'equipment_accounting:video_template_create' %}" class="button">+ Додати</a>
        </div>

        {% if video_templates %}
        <table class="eq-table">
            <thead>
                <tr>
                    <th>Назва</th>
                    <th>Тип дрона</th>
                    <th>Сигнал</th>
                    <th>Дальність</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for vt in video_templates %}
                <tr>
                    <td data-label="Назва">{{ vt.name }}</td>
                    <td data-label="Тип дрона">{{ vt.drone_model|default:"—" }}</td>
                    <td data-label="Сигнал">{% if vt.is_analog %}Аналоговий{% else %}Цифровий{% endif %}</td>
                    <td data-label="Дальність">{{ vt.max_distance }} км</td>
                    <td data-label="" class="actions-cell">
                        <a href="{% url 'equipment_accounting:video_template_edit' vt.pk %}" class="btn-sm">Редагувати</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>Шаблонів відео немає.</p></div>
        {% endif %}
    </div>
</div>

<script>
(function() {
    /* Tabs */
    var btns = document.querySelectorAll('.tab-btn');
    var panels = document.querySelectorAll('.tab-panel');
    btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            btns.forEach(function(b) { b.classList.remove('active'); });
            panels.forEach(function(p) { p.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    /* Auto-submit filter forms on change */
    document.querySelectorAll('.filter-bar').forEach(function(form) {
        form.querySelectorAll('select, input[type="date"]').forEach(function(el) {
            el.addEventListener('change', function() { form.submit(); });
        });
    });

    /* Bulk selection */
    var checkAll = document.getElementById('check-all');
    var bulkBar = document.getElementById('bulk-bar');
    var bulkCount = document.getElementById('bulk-count-num');
    var bulkForm = document.getElementById('bulk-form');
    var bulkSubmit = document.getElementById('bulk-submit');
    var actionSelect = document.getElementById('bulk-action-select');

    if (!checkAll) return;

    var rowChecks = document.querySelectorAll('.row-check');

    function updateBulkBar() {
        var checked = document.querySelectorAll('.row-check:checked');
        var count = checked.length;
        bulkCount.textContent = count;
        if (count > 0) {
            bulkBar.classList.add('visible');
        } else {
            bulkBar.classList.remove('visible');
        }
        checkAll.checked = count > 0 && count === rowChecks.length;
        checkAll.indeterminate = count > 0 && count < rowChecks.length;
    }

    checkAll.addEventListener('change', function() {
        rowChecks.forEach(function(cb) { cb.checked = checkAll.checked; });
        updateBulkBar();
    });

    rowChecks.forEach(function(cb) {
        cb.addEventListener('change', updateBulkBar);
    });

    // Show/hide location selector based on chosen bulk action
    var bulkLocationSelect = document.getElementById('bulk-location-select');
    actionSelect.addEventListener('change', function() {
        var action = actionSelect.value;
        var needsLocation = (action === 'given' || action === 'repair');
        if (bulkLocationSelect) {
            bulkLocationSelect.style.display = needsLocation ? '' : 'none';
        }
    });

    bulkSubmit.addEventListener('click', function(e) {
        var action = actionSelect.value;
        if (!action) {
            e.preventDefault();
            showModal('warn-modal', 'Увага', 'Оберіть дію перед застосуванням.');
            return;
        }
        if (action === 'delete') {
            e.preventDefault();
            var count = document.querySelectorAll('.row-check:checked').length;
            showModal(
                'confirm-modal',
                'Видалити БПЛА',
                'Видалити ' + count + ' БПЛА? Цю дію не можна скасувати.',
                function() { bulkForm.submit(); }
            );
        }
    });
})();

// Component bulk selection
(function () {
    var compCheckAll = document.getElementById('comp-check-all');
    var compBulkBar  = document.getElementById('comp-bulk-bar');
    var compBulkCount = document.getElementById('comp-bulk-count-num');
    var compBulkForm  = document.getElementById('comp-bulk-form');
    var compBulkSubmit = document.getElementById('comp-bulk-submit');

    if (!compCheckAll) return;

    var compRowChecks = document.querySelectorAll('.comp-row-check');

    function updateCompBulkBar() {
        var checked = document.querySelectorAll('.comp-row-check:checked');
        var count = checked.length;
        compBulkCount.textContent = count;
        compBulkBar.classList.toggle('visible', count > 0);
        compCheckAll.checked = count > 0 && count === compRowChecks.length;
        compCheckAll.indeterminate = count > 0 && count < compRowChecks.length;
    }

    compCheckAll.addEventListener('change', function () {
        compRowChecks.forEach(function (cb) { cb.checked = compCheckAll.checked; });
        updateCompBulkBar();
    });

    compRowChecks.forEach(function (cb) {
        cb.addEventListener('change', updateCompBulkBar);
    });

    compBulkSubmit.addEventListener('click', function (e) {
        e.preventDefault();
        var count = document.querySelectorAll('.comp-row-check:checked').length;
        showModal(
            'confirm-modal',
            'Видалити комплектуючі',
            'Видалити ' + count + ' комплектуючих? Цю дію не можна скасувати.',
            function () { compBulkForm.submit(); }
        );
    });
})();

// Per-row give modal
function openGiveModal(url) {
    var overlay = document.getElementById('give-modal');
    var locationSelect = document.getElementById('give-location-select');
    var confirmBtn = document.getElementById('give-confirm-btn');
    var cancelBtn = overlay.querySelector('.btn-cancel');

    // Reset location selection
    if (locationSelect) locationSelect.value = '';

    overlay.classList.add('visible');

    function close() {
        overlay.classList.remove('visible');
        confirmBtn.removeEventListener('click', onConfirm);
        cancelBtn.removeEventListener('click', close);
        document.removeEventListener('keydown', onKey);
        overlay.removeEventListener('click', onOverlay);
    }

    function onConfirm() {
        var form = document.getElementById('give-action-form');
        var locationInput = document.getElementById('give-action-location');
        form.action = url;
        locationInput.value = locationSelect ? locationSelect.value : '';
        close();
        form.submit();
    }

    function onKey(e) { if (e.key === 'Escape') close(); }
    function onOverlay(e) { if (e.target === overlay) close(); }

    confirmBtn.addEventListener('click', onConfirm);
    cancelBtn.addEventListener('click', close);
    document.addEventListener('keydown', onKey);
    overlay.addEventListener('click', onOverlay);
}

/* Modal helper */
function showModal(id, title, message, onConfirm) {
    var overlay = document.getElementById(id);
    overlay.querySelector('h3').textContent = title;
    overlay.querySelector('p').textContent = message;
    overlay.classList.add('visible');

    var confirmBtn = overlay.querySelector('.btn-confirm-danger, .btn-confirm-warn');
    var cancelBtn = overlay.querySelector('.btn-cancel');

    function close() { overlay.classList.remove('visible'); cleanup(); }
    function confirm() { close(); if (onConfirm) onConfirm(); }

    function onKey(e) { if (e.key === 'Escape') close(); }
    function onOverlay(e) { if (e.target === overlay) close(); }

    function cleanup() {
        cancelBtn.removeEventListener('click', close);
        if (confirmBtn) confirmBtn.removeEventListener('click', confirm);
        document.removeEventListener('keydown', onKey);
        overlay.removeEventListener('click', onOverlay);
    }

    cancelBtn.addEventListener('click', close);
    if (confirmBtn) confirmBtn.addEventListener('click', confirm);
    document.addEventListener('keydown', onKey);
    overlay.addEventListener('click', onOverlay);
}

// ── Excel export column chooser ──────────────────────────────────────
(function () {
    var toggleBtn = document.getElementById('export-toggle-btn');
    var panel = document.getElementById('export-panel');
    var dlBtn = document.getElementById('export-dl-btn');
    if (!toggleBtn) return;

    toggleBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        panel.classList.toggle('open');
    });

    document.addEventListener('click', function (e) {
        if (!panel.contains(e.target) && e.target !== toggleBtn) {
            panel.classList.remove('open');
        }
    });

    dlBtn.addEventListener('click', function () {
        var base = "{% url 'equipment_accounting:uav_export_excel' %}?";
        panel.querySelectorAll('input[name="xcol"]').forEach(function (cb) {
            base += 'col_' + cb.value + '=' + (cb.checked ? '1' : '0') + '&';
        });
        window.location.href = base;
        panel.classList.remove('open');
    });
})();
</script>

{# Warning modal (single button) #}
<div class="modal-overlay" id="warn-modal">
    <div class="modal-box">
        <h3></h3>
        <p></p>
        <div class="modal-actions">
            <button type="button" class="btn-cancel">Зрозуміло</button>
        </div>
    </div>
</div>

{# Confirm delete modal (two buttons) #}
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-box">
        <h3></h3>
        <p></p>
        <div class="modal-actions">
            <button type="button" class="btn-cancel">Скасувати</button>
            <button type="button" class="btn-confirm-danger">Видалити</button>
        </div>
    </div>
</div>

{# Give modal — location picker for per-row give action #}
<div class="modal-overlay" id="give-modal">
    <div class="modal-box">
        <h3>Віддати БПЛА</h3>
        <p>Куди переміщується дрон? (необов'язково)</p>
        <div style="margin-bottom: 1.25rem;">
            <select id="give-location-select" style="width:100%; padding: 0.55rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--input-bg); color: var(--text); font-size: 0.85rem; font-family: inherit; outline: none;">
                <option value="">— Не вказано —</option>
                {% for loc in locations %}
                <option value="{{ loc.pk }}">{{ loc.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-cancel">Скасувати</button>
            <button type="button" class="btn-confirm-warn" id="give-confirm-btn">Віддати</button>
        </div>
    </div>
</div>

{# Hidden form for per-row give action (outside bulk form to avoid nesting) #}
<form method="post" id="give-action-form" action="" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="to_location_id" id="give-action-location" value="">
</form>
{% endblock %}
