name: Deploy

on:
  push:
    branches: [ master ]

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to server (SSH key file)
    environment: production
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH key + known_hosts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # write key safely, normalize CRLF
          umask 077
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_deploy

          # validate key format (will fail if invalid)
          ssh-keygen -lf ~/.ssh/id_deploy >/dev/null

          # trust host key
          ssh-keyscan -H 85.121.4.216 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy
        shell: bash
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_deploy -o BatchMode=yes root@85.121.4.216 << 'EOF'
            set -euo pipefail
            cd /root/MyProjects/python/app_drones

            # Update codebase
            git fetch --all --prune
            git checkout master
            git reset --hard origin/master

            # The production DB has a duplicate column from a previous failed migration.
            # We fake-apply the problematic migration to sync the migration history.
            docker exec app_drones /bin/bash -c "source /app/.venv/bin/activate && python /app/manage.py migrate equipment_accounting 0003_add_is_unusable_column --fake"

            # Apply all other database migrations
            docker exec app_drones /bin/bash -c "source /app/.venv/bin/activate && python /app/manage.py migrate --no-input"

            # Find all fixtures and apply them
            FIXTURE_NAMES=$(find . -path '*/fixtures/*.json' -exec basename {} .json \; | tr '\n' ' ')
            if [ -n "$FIXTURE_NAMES" ]; then
              docker exec app_drones /bin/bash -c "source /app/.venv/bin/activate && python /app/manage.py loaddata $FIXTURE_NAMES"
            fi

            # Reload services
            docker exec app_drones nginx -s reload
          EOF
